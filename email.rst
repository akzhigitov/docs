Email-рассылки
==============

SMTP API
~~~~~~~~

Обзор
-----

Платформа Devino Telecom позволяет клиентам отправлять транзакционные (одиночные) email-сообщения с помощью стандартного протокола SMTP. Данный вид интеграции позволит легко подключить CRM, CMS или другую систему к платформе Devino Telecom для отправки email-сообщений вашим клиентам. При отправке сообщений через протокол SMTP платформа DevinoTelecom будет автоматически фильтровать отписавшиеся и hard bounce адреса.

Подключение
-----------

Для того, чтобы начать отправлять транзакционные email-сообщения по протоколу SMTP, вам необходимо:
Зарегистрироваться в личном кабинете Devino Telecom.
Получить SMTP-логин и SMTP-пароль у вашего персонального менеджера, либо через службу технической поддержки
Сообщить IP-адрес, с которого вы будете подключаться к платформе Devino Telecom, вашему персональному менеджеру, либо службе технической поддержки.
Прописать в качестве SMTP-сервера для вашего приложения адрес integrationapi.net, порт 587 (TLS), либо 465 (SSL)
Указать SMTP-логин и SMTP-пароль, полученные на шаге 2.

Отправка: требования и ограничения
----------------------------------

При отправке email-сообщений необходимо соблюдать следующие правила:

Использовать подтвержденный адрес отправителя (Вы можете запросить адрес отправителя в личном кабинете на странице создания email-рассылки)
Указывать корректный адрес получателя
Не отправлять письма, размер которых превышает 10 Мб.
Не загружать в письмо файлы со следующими расширениями:  .adp .bat .chm .cmd .com .cpl .exe .hta .ins .isp .jar .js .jse .lib .lnk .mde .msc .msp .mst .pif .scr .sct .shb .sys .vb .vbe .vbs .vxd .wsc .wsf .wsh
Не указывать в поле "TO" несколько адресов получателя, так как отправка будет сделана только на первый адрес.
Сообщения отправляются в кодировке UTF-8.

Дополнительные функции: ссылка на отписку
-----------------------------------------

Вы можете добавить в письмо ссылку на отписку. Для этого необходимо в теле сообщения передавать тег [Unsubscribe]

Пример:
Если вы хотите отписаться от рассылки нажмите <a href="[Unsubscribe]">здесь</a>

Получение статистики
--------------------

Статистика по письмам отправленным через SMTP-протокол собирается аналогично статистике по рассылкам отправленным из личного кабинета.
Таким образом вы сможете видеть полноценную статистику по прочитанным письмам, кол-ву переходов по ссылке, кол-ву ошибок при доставке и т.д.
Статистику по транзакционным email-сообщениям вы можете получить в личном кабинете на странице "Статистика".

smtp1.jpg

Обработка ошибок
----------------

В случае возникновения ошибки при валидации email-сообщения, платформа Devino Telecom возвращает стандартный код ошибки SMTP 554 Transaction failed и текстовое описание.

Возможные описания ошибок:

+-------------------------------------------------+-------------------------------------------------+
| Текст ошибки                                    | Причина                                         |
+=================================================+=================================================+
| Must authenticate before sending mail           | Не указан, или указан некорректный логин/пароль |
+-------------------------------------------------+-------------------------------------------------+
| Internal server error                           | Ошибка сервера                                  |
+-------------------------------------------------+-------------------------------------------------+
| Not allowed attachement type <расширение файла> | Загружен запрещенный файл                       |
+-------------------------------------------------+-------------------------------------------------+
| Message exceeds fixed size limit                | Превышен допустимый размер письма               |
+-------------------------------------------------+-------------------------------------------------+
| Invalid recipient address: <адрес получателя>   | Некорректный адрес получателя                   |
+-------------------------------------------------+-------------------------------------------------+
| Disallowed source address: <адрес отправителя>  | Неподтвержденный адрес отправителя              |
+-------------------------------------------------+-------------------------------------------------+


Настройка почтового клиента Outlook
-----------------------------------

Необходимо создать учетную запись типа "IMAP/SMTP", для этого:
Откройте Outlook
Файл --> Добавить учетную запись
Ручная настройка или дополнительные типы серверов --> Далее
Протокол POP или IMAP --> Далее
Заполните поля, используя данные учетной записи любого почтового сервиса:
Имя -  любое имя 
Адрес электронной почты
Тип учетной записи - IMAP
Сервер входящей почты -  например,  imap.gmail.com 
Сервер исходящей почты (SMTP): integrationapi.net
Пользователь/пароль - данные для входа в учетную запись
--> Другие настройки --> Сервер исходящей почты -->  Smtp серверу требуется проверка подлинности --> Вход с помощью --> ввести smtp-логин и smtp-пароль
--> Дополнительно --> Smtp-сервер - указать порт 587
--> Сохранить.

Отправка письма из .NET
-----------------------

.. code-block:: 	

    using System;
    using System.Diagnostics;
    using System.Net;
    using System.Net.Mail;
    namespace Devino.Email.SmtpClient
    {
        class Program
        {
            static void Main(string[] args)
            {
                using (var smtpClient = new SmtpClient())
                {
                    var sourceEmail = "noreplay@devinotele.com";
                    var subject = "Test from smtp";
                    var messageText = "Привет! <a href=\"http://www.devinotele.com\">Кликни меня</a>";
                    var email = "test@devinotele.com";
                     
                    smtpClient.Host = "integrationapi.net";
                    smtpClient.Port = 587;
                    smtpClient.EnableSsl = true;
                    smtpClient.Credentials = new NetworkCredential("1website", "test");
                    
                    var message = new MailMessage(sourceEmail, email) { Sender = new MailAddress(sourceEmail), Subject = subject, Body = messageText };
                    try
                    {
                        smtpClient.Send(message);
                    }
                    catch (Exception ex)
                    {
                        Trace.TraceError(ex.Message);
                    }
                }
            }
        }
    }
    

HTTP API
~~~~~~~~

Обзор
-----

API предоставляет удобный интерфейс для автоматизации процесса отправки email-рассылок через платформу Devino Telecom. С помощью API можно отправлять массовые и транзакционные email-рассылки, управлять рассылками, получать полноценную статистику. Работа с API осуществляется в соответствии с принципами REST, посредством HTTP-запросов с использованием методов GET, POST, PUT, PATCH и DELETE.
Для использования API необходима авторизация. Авторизация происходит по логину паролю от Личного Кабинета платформы Devino Telecom.

Авторизация
-----------

API поддерживает базовую авторизацию через заголовок Authorization (https://en.wikipedia.org/wiki/Basic_access_authentication). В заголовке запроса необходимо передать логин и пароль из Личного Кабинета в формате login:password в base64 кодировке.

Authorization: Basic dGVzdGVyOjExMTExMQ==

Формат запроса
--------------

Запрос к API задается в следующем формате
{тип_метода} https://integrationapi.net/email/v{версия}/{ресурс}?{параметры}
где:
{тип_метода} - HTTP метод GET, POST, PUT, PATCH и DELETE.
{версия} - Версия API. Текущая версия - 1.
{ресурс} - URL ресурса, над которым выполняется действие. Список всех ресурсов смотрите в соответствующем разделе.
{параметры} - обязательные и необязательные параметры запроса, которые не входят в состав URL ресурса.
Обязательный пункт: Accept */*
Сервис позволяет передавать параметры и получать ответы в следующих форматах: JSON и XML.

Формат ответа
-------------

Ответ API состоит из двух частей:
Код с описанием - эта часть присутствует во всех ответах.
Результат - специфичный для каждого запроса. Может отсутствовать.

.. code-block:: json
  
      {    "Result":{
              ...
          },
          "Code": "not_found",
          "Description": "user not found"
      }
      

Код можно использовать для проверки статуса запроса, а описание предназначено для диагностики возможных проблем. Описание может быть изменено в новой версии API без предупреждения о нарушении обратной совместимости. Набор кодов также может быть расширен.


Список кодов ответов

+----------------------+-------------+---------------------------------+
| Код                  | HTTP status | Расшифровка                     |
+======================+=============+=================================+
| ok                   |  200, 201   | Запрос выполнен успешно         |
+----------------------+-------------+---------------------------------+
| not_changed          |  200        | Ресурс не изменён               |
+----------------------+-------------+---------------------------------+
| invalid_email        |  400        | Передан невалидный email адрес  |
+----------------------+-------------+---------------------------------+
| not_found            |  404        | Ресурс не найден                |
+----------------------+-------------+---------------------------------+
| empty_value          |  400        | Не передан один из обязательный |
|                      |             | параметров                      |
+----------------------+-------------+---------------------------------+
| invalid_value        |  400        | Передано невалидное значение    |
|                      |             | параметра                       |
+----------------------+-------------+---------------------------------+
| missing_macros       |  400        | Не найден один из обязательных  |
|                      |             | макросов в тексте рассылки      |
+----------------------+-------------+---------------------------------+
| size_exceeded        |  400        |Превышен допустимый размер данных|
+----------------------+-------------+---------------------------------+
| internal_error       |  500        | Внутренняя ошибка сервиса       |
+----------------------+-------------+---------------------------------+
| not_available        |  400        | Действие не доступно            |
+----------------------+-------------+---------------------------------+
| invalid_permission   |  403        | Не достаточно разрешений для    |
|                      |             | вызова метода                   |
+----------------------+-------------+---------------------------------+
| access_denied        |  403        | Нет доступа к запрошенному      |
|                      |             | ресурсу                         |
+----------------------+-------------+---------------------------------+
| authorization_failed |  401        | Ошибка авторизации              |
+----------------------+-------------+---------------------------------+

Ресурсы
-------

Список всех ресурсов, которые предоставляет API:

+----------------------------+---------+----------------------------------+
| Ресурс                     | Метод   | Описание                         |
+============================+=========+==================================+
| /Tasks/{TaskId}/State      |  PUT    | Изменение статуса рассылки       |
+----------------------------+---------+----------------------------------+
| /Tasks/{TaskId}/Attachments|  GET    | Получение аттачей рассылки       |
+----------------------------+---------+----------------------------------+
| /Tasks/{TaskId}/Attachments|  POST   | Добавление аттача в рассылку     |
+----------------------------+---------+----------------------------------+
| /Tasks/{TaskId}/Attachments|  DELETE | Удаление аттачей из рассылки     |
+----------------------------+---------+----------------------------------+
| /Tasks/{TaskId}            |  GET    | Получение рассылки               |
+----------------------------+---------+----------------------------------+
| /Tasks/{TaskId}            |  PATCH  | Редактирование рассылки          |
+----------------------------+---------+----------------------------------+
| /Tasks                     |  POST   | Создание рассылки                |
+----------------------------+---------+----------------------------------+
| /Messages                  |  POST   |Отправка транзакционного сообщения|
+----------------------------+---------+----------------------------------+

Получение рассылки
------------------

ET /Tasks/{TaskId}
Метод возвращает данные рассылки.

Параметры запроса

+----------------+------------+--------------+-----------------------------------------+
|     Параметр   | Тип данных |Обязательность| Описание                                |
+================+============+==============+=========================================+
| TaskId         |  int       | Да           | Идентификатор рассылки (предаётся в url)|
+----------------+------------+--------------+-----------------------------------------+

Возвращаемый результат

